name: Test Env Vars on EC2

on:
  push:
    branches:
      - main  # Trigger on push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository (even though we don't need to build anything, we may need the code in some cases)
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Set environment variables using secrets and deploy to EC2 for testing
      - name: Test Env Vars on EC2
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}  # EC2 private key (e.g., PEM file)
          HOST: ${{ secrets.EC2_HOST }}  # EC2 host/IP
          USER: ${{ secrets.EC2_USER }}  # EC2 user (e.g., ubuntu)
        run: |
          # Create the SSH private key file
          echo "$PRIVATE_KEY" > github-ec2.pem && chmod 600 github-ec2.pem

          # SSH into EC2 instance and test the environment variables
          ssh -o StrictHostKeyChecking=no -i github-ec2.pem ${USER}@${HOST} << 'EOF'
            # Check current directory and environment variables
            echo "Current directory: $(pwd)"
            echo "Listing home directory:"
            ls -la ~

            # Print out the passed environment variables for testing
            echo "Domain Name: $DOMAIN_NAME"
            echo "Email User: $EMAIL_USER"
            echo "Email Pass: $EMAIL_PASS"

            # You can add other commands for further testing, but no deployment is needed
          EOF
