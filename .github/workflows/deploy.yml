name: Test Env Vars on EC2

on:
  push:
    branches:
      - main  # Trigger on push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v2

      # Step 2: Test passing environment variables to EC2
      - name: Test Env Vars on EC2
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}  # EC2 private key (e.g., PEM file)
          HOST: ${{ secrets.EC2_HOST }}  # EC2 host/IP
          USER: ${{ secrets.EC2_USER }}  # EC2 user (e.g., ubuntu)
        run: |
          # Create the SSH private key file
          echo "$PRIVATE_KEY" > github-ec2.pem && chmod 600 github-ec2.pem

          # SSH into EC2 and pass environment variables explicitly
          ssh -o StrictHostKeyChecking=no -i github-ec2.pem -o SendEnv=DOMAIN_NAME -o SendEnv=EMAIL_USER -o SendEnv=EMAIL_PASS ${USER}@${HOST} << 'EOF'
            # Check if environment variables are available
            echo "Domain Name: $DOMAIN_NAME"
            echo "Email User: $EMAIL_USER"
            echo "Email Pass: $EMAIL_PASS"

            # You can check other environment variables or run deployment steps here
          EOF
